<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Employer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
<header class="header p-3 border-bottom" th:with="user=${session.loggedInUser}">
    <div class="container d-flex justify-content-between align-items-center">
        <a th:href="@{/MainGallery/HomePage}" class="logo fs-4 fw-bold text-decoration-none">LOGO GOES HERE</a>

        <nav class="nav-items d-flex align-items-center gap-3">
            <a th:href="@{/MainGallery/HomePage}" class="text-decoration-none">Home</a>
            <a th:if="${user == null}" th:href="@{/MainGallery/Register}" class="text-primary text-decoration-none">Register</a>
            <a th:if="${user == null}" th:href="@{/MainGallery/Login}" class="text-primary text-decoration-none">Sign-In</a>
            <a th:if="${user != null}" th:href="@{/MainGallery/profile}" class="text-decoration-none">Profile</a>
            <a th:if="${user != null}" th:href="@{/MainGallery/Logout}" onclick="return confirm('Log out now?')" class="text-decoration-none">
                Logout
            </a>
            <div class="icon-button" th:with="isLoggedIn=${user != null}">
                <a th:if="${isLoggedIn}" th:href="@{/MainGallery/profile}"><i class="fas fa-user"></i></a>
                <a th:if="${!isLoggedIn}" th:href="@{/MainGallery/Login}"><i class="fas fa-user"></i></a>
            </div>
        </nav>
    </div>
</header>

<div class="container my-5" th:with="user=${session.loggedInUser}">
    <h1 class="mb-4">Welcome to the Employer Dashboard!</h1>

    <!-- üîç Search -->
    <div class="mb-4">
        <form th:action="@{/MainGallery/searchSaved}" method="get" class="d-flex gap-2">
            <input type="text" name="keyword"
                   th:value="${keyword}"
                   placeholder="Search your saved projects..."
                   class="form-control" style="max-width:400px;">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
        <a th:if="${keyword != null and !#strings.isEmpty(keyword)}"
           th:href="@{/MainGallery/employerDashboard}"
           class="small text-muted text-decoration-none ms-2">
            Clear search
        </a>
    </div>

    <!-- üóÇ No results -->
    <div th:if="${#lists.isEmpty(saved)}" class="text-center text-muted py-5">
        <h5>No saved projects yet</h5>
        <p>Browse the homepage and click ‚ÄúSave to list‚Äù on projects you want to track.</p>
        <a th:href="@{/MainGallery/HomePage}" class="btn btn-primary mt-2">Browse Projects</a>
    </div>

    <!-- üíæ Saved Projects Grid -->
    <div class="row" th:if="${!#lists.isEmpty(saved)}">
        <div class="col-md-6 col-lg-4 mb-4" th:each="sp : ${saved}">
            <div class="card h-100 shadow-sm">
                <img th:src="@{'/assets/images/projects/thumbnail/thumb_' + ${sp.project.projectHeroImage}}"
                     class="card-img-top" alt="Project Image"
                     style="height:180px;object-fit:cover;">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title" th:text="${sp.project.projectName}">Project Name</h5>
                    <p class="card-text text-truncate" th:text="${sp.project.projectDescription}">Project description</p>


                    <div class="mt-auto pt-3 d-flex gap-2">
                        <button class="btn btn-sm btn-outline-info w-100"
                                th:onclick="'openSavedProjectModal(' + ${sp.project.projectId} + ')'"
                                type="button">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                        <form th:action="@{/MainGallery/employer/deleteSaved}" method="post" style="display:inline;">
                            <input type="hidden" name="projectId" th:value="${sp.project.projectId}">
                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Remove this project from your saved list?');">
                                Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üü£ Modal: Project Drill-down -->
<div class="modal fade" id="savedProjectModal" tabindex="-1" aria-labelledby="savedProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="savedProjectModalLabel">Project Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-5 text-center">
                        <img id="savedProjectImage" class="img-fluid rounded shadow-sm"
                             style="max-height: 250px; object-fit: cover;" alt="Project image">
                    </div>
                    <div class="col-md-7">
                        <h5 id="savedProjectName"></h5>
                        <p id="savedProjectDescription" class="small text-muted"></p>
                        <p><strong>Student:</strong> <span id="savedProjectCreator"></span></p>
                        <p><strong>Saved on:</strong> <span id="savedProjectSavedOn"></span></p>
                        <p><strong>Project created on:</strong> <span id="savedProjectProjectCreatedOn"></span></p>

                        <hr>
                        <h6>Your Note</h6>
                        <textarea id="savedProjectNoteInput" class="form-control mb-2" rows="3"
                                  placeholder="Write your note here..."></textarea>
                        <button id="savedProjectNoteSaveBtn" class="btn btn-sm btn-primary">
                            <i class="fas fa-save"></i> Save Note
                        </button>
                        <span id="savedProjectNoteStatus" class="ms-2 small"></span>
                    </div>
                </div>
            </div>

            <div class="modal-footer bg-light">
                <a id="savedProjectViewBtn" href="#" class="btn btn-primary" target="_blank">View Full Project</a>
                <button id="savedProjectRemoveBtn" type="button" class="btn btn-outline-danger">Remove</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<footer class="text-center text-muted py-4 border-top">
    ¬© 2024 TUS GALLERY
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function formatDate(value) {
        if (!value) return "N/A";
        const d = new Date(value);
        if (isNaN(d.getTime())) return value;
        return d.toLocaleString();
    }

    async function openSavedProjectModal(projectId) {
        try {
            const response = await fetch(`/MainGallery/employer/saved/${projectId}/json`);
            const saved = await response.json();

            if (!saved || !saved.project) {
                alert("Project details unavailable.");
                return;
            }

            const p = saved.project;
            document.getElementById("savedProjectName").textContent = p.projectName || "Untitled";
            document.getElementById("savedProjectDescription").textContent = p.projectDescription || "No description available.";
            document.getElementById("savedProjectCreator").textContent = p.user?.userName || "Unknown student";

            document.getElementById("savedProjectSavedOn").textContent = formatDate(saved.createdAt);
            document.getElementById("savedProjectProjectCreatedOn").textContent = formatDate(p.creationDate);

            // Load existing note
            const noteInput = document.getElementById("savedProjectNoteInput");
            noteInput.value = saved.note || "";

            // Handle image
            const img = document.getElementById("savedProjectImage");
            img.src = p.projectHeroImage
                ? `/assets/images/projects/${p.projectHeroImage}`
                : "/assets/images/default-project.jpg";

            // Buttons
            document.getElementById("savedProjectViewBtn").href = `/project/projectDetails/${p.projectId}`;
            document.getElementById("savedProjectRemoveBtn").onclick = () => removeSavedProject(p.projectId);

            // ‚úÖ Save note logic
            const statusLabel = document.getElementById("savedProjectNoteStatus");
            const saveBtn = document.getElementById("savedProjectNoteSaveBtn");
            saveBtn.onclick = async () => {
                const newNote = noteInput.value.trim();
                const formData = new FormData();
                formData.append("projectId", p.projectId);
                formData.append("note", newNote);

                try {
                    const resp = await fetch("/MainGallery/employer/updateNote", {
                        method: "POST",
                        body: formData
                    });
                    if (resp.ok) {
                        statusLabel.textContent = "‚úÖ Saved";
                        statusLabel.style.color = "green";
                    } else {
                        statusLabel.textContent = "‚ö†Ô∏è Failed to save note";
                        statusLabel.style.color = "red";
                    }
                } catch (err) {
                    statusLabel.textContent = "‚ùå Error saving note";
                    statusLabel.style.color = "red";
                    console.error(err);
                }

                // Clear status after a short delay
                setTimeout(() => statusLabel.textContent = "", 3000);
            };

            new bootstrap.Modal(document.getElementById("savedProjectModal")).show();
        } catch (e) {
            console.error(e);
            alert("Error loading project details.");
        }
    }
</script>


</body>
</html>
