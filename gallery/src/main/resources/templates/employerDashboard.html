<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Employer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/navBar.css">
    <link rel="stylesheet" href="/assets/css/employer.css">
    <link rel="stylesheet" href="/assets/css/footer.css">
    <!-- favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/images/website/Future_Proof_Logo_Icon.png">

</head>

<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm" th:with="user=${session.loggedInUser}">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" th:href="@{/MainGallery/HomePage}">
            <img src="/assets/images/website/Future_Proof_Logo.png" alt="Logo" height="40" class="me-2">
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-end" id="navbarContent">
            <ul class="navbar-nav mb-2 mb-lg-0 align-items-lg-center">
                <li class="nav-item"><a class="nav-link" th:href="@{/MainGallery/HomePage}">Home</a></li>

                <li class="nav-item"><a class="nav-link" href="#footer-contact">Contact</a></li>

                <li class="nav-item" th:if="${user == null}">
                    <a class="nav-link text-primary" th:href="@{/MainGallery/Register}">Register</a>
                </li>
                <li class="nav-item" th:if="${user == null}">
                    <a class="nav-link text-primary" th:href="@{/MainGallery/Login}">Login</a>
                </li>

                <li>
        <span class ="dashboard" th:if="${user != null}" th:switch="${#strings.toLowerCase(user.userType)}">
    <a th:case="'admin'"        th:href="@{/MainGallery/adminDashboard}">Dashboard</a>
    <a th:case="'senioradmin'"  th:href="@{/MainGallery/seniorAdminDashboard}">Dashboard</a>
    <a th:case="'student'"      th:href="@{/MainGallery/studentDashboard}">Dashboard</a>
    <a th:case="'employer'"     th:href="@{/MainGallery/employerDashboard}">Dashboard</a>
    <a th:case="*"              th:href="@{/MainGallery/dashboard}">Dashboard</a>
  </span>
                </li>

            </ul>

            <!-- Profile Icon -->
            <a th:if="${user != null}" th:href="@{/MainGallery/profile}">
                <img src="/assets/images/website/Profile.png" alt="Profile_Icon" height="40" class="me-2">
            </a>
            <a th:if="${user == null}" th:href="@{/MainGallery/Login}">
                <img src="/assets/images/website/Profile.png" alt="Profile_Icon" height="40" class="me-2">
            </a>
        </div>
    </div>
</nav>

<!-- End of NavBar -->

<!-- Add top padding so content isn't hidden under fixed navbar -->
<style>
    body {
        padding-top: 100px;
    }
    .nav-link {
        color: #4c6873 !important;
        font-weight: 500;
        margin: 0 6px;
        transition: color 0.2s ease;
    }
    .nav-link:hover, .nav-link.active {
        color: #005b73 !important;
    }
    .navbar-brand span {
        font-size: 1.2rem;
        letter-spacing: 0.5px;
    }
</style>

<div class="top-header-container">
    <h2 class="top-header-title">
        Welcome back, <span th:text="${session.loggedInUser.userName}">User</span>!
    </h2>

    <form th:action="@{/MainGallery/employerDashboard}" method="get" class="search-wrapper">

        <!-- FILTER BUTTON -->
        <button type="button" class="search-filter-btn" id="employerFilterToggle">
            <i class="fa-solid fa-filter"></i>
        </button>

        <!-- SEARCH INPUT -->
        <input type="text"
               name="keyword"
               th:value="${keyword}"
               placeholder="Search your saved projects..."
               class="search-input">

        <!-- SEARCH BUTTON -->
        <button type="submit" class="search-btn">
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>
    </form>

    <!-- Clear Search (appears only after searching) -->
    <a th:if="${keyword != null and !#strings.isEmpty(keyword)}"
       th:href="@{/MainGallery/employerDashboard}"
       class="clear-search-link">
        Clear search
    </a>
</div>

<div class="card-layout">

    <!-- üóÇ No results -->
    <div th:if="${savedPage.totalElements == 0}" class="text-center text-muted py-5">
        <h5>No saved projects yet</h5>
        <p>Browse the homepage and click ‚ÄúSave to list‚Äù on projects you want to track.</p>
        <a th:href="@{/MainGallery/HomePage}" class="btn btn-primary mt-2">Browse Projects</a>
    </div>

    <!-- üíæ Saved Projects Grid + Bulk Delete -->
    <form id="employerBulkDeleteForm"
          method="post"
          th:if="${savedPage.totalElements > 0}"
          th:action="@{/MainGallery/employer/bulkDeleteSaved}">

        <div class="d-flex justify-content-between align-items-center mt-3 mb-3 bulk-actions-bar">
            <div class="d-flex align-items-center gap-2">
                <input type="checkbox" id="selectAllSavedProjects" class="form-check-input">
                <label for="selectAllSavedProjects"
                       class="mb-0 select-all-label">
                    Select all
                </label>
            </div>

            <button type="submit"
                    class="btn btn-danger btn-sm"
                    id="deleteSelectedSavedBtn"
                    disabled>
                Delete Selected
            </button>
        </div>

        <div class="row">
            <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4"
                 th:each="sp : ${savedPage.content}">

                <div class="card h-100 shadow-sm position-relative">

                    <!-- Checkbox for this saved project -->
                    <div class="position-absolute m-2">
                        <input type="checkbox"
                               class="form-check-input saved-select-checkbox"
                               name="selectedProjectIds"
                               th:value="${sp.project.projectId}">
                    </div>

                    <img th:src="@{'/assets/images/projects/thumbnail/thumb_' + ${sp.project.projectHeroImage}}"
                         class="card-img-top"
                         alt="Project Image">

                    <div class="card-body d-flex flex-column">

                        <h5 class="card-title" th:text="${sp.project.projectName}">Project Name</h5>
                        <p class="card-text text-truncate"
                           th:text="${sp.project.projectDescription}">
                        </p>

                        <div class="mt-auto pt-3 d-flex gap-2">

                            <!-- View details (modal) -->
                            <button class="btn-view-details"
                                    th:onclick="'openSavedProjectModal(' + ${sp.project.projectId} + ')'"
                                    type="button">
                                View Details
                            </button>

                            <!-- Single delete: uses same form, but own action -->
                            <button type="submit"
                                    class="btn-delete"
                                    formmethod="post"
                                    th:formaction="@{/MainGallery/employer/deleteSaved(projectId=${sp.project.projectId})}"
                                    onclick="return confirm('Remove this project from your saved list?');">
                                <i class="fa-solid fa-trash"></i>
                            </button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Employer Filter Sidebar -->
    <div id="employerFilterSidebar" class="fp-filter-sidebar">
        <div class="fp-filter-sidebar-header">
            <h5>Filter saved projects</h5>
            <button type="button" class="fp-filter-close" id="employerFilterClose">&times;</button>
        </div>

        <form th:action="@{/MainGallery/employerDashboard}" method="get" class="fp-filter-sidebar-body">

            <!-- keep keyword in sync when applying filters -->
            <input type="hidden" name="keyword" th:value="${keyword}"/>

            <div class="fp-filter-group">
                <label for="sortBy" class="fp-filter-label">Sort by</label>
                <select id="sortBy" name="sortBy" class="fp-filter-select">
                    <option value="" th:selected="${sortBy == null or sortBy == ''}">Newest first</option>
                    <option value="OLDEST" th:selected="${sortBy == 'OLDEST'}">Oldest first</option>
                    <option value="NAME_ASC" th:selected="${sortBy == 'NAME_ASC'}">Name A‚ÄìZ</option>
                    <option value="NAME_DESC" th:selected="${sortBy == 'NAME_DESC'}">Name Z‚ÄìA</option>
                </select>
            </div>

            <div class="fp-filter-actions">
                <button type="submit" class="fp-filter-apply">Apply</button>
                <a th:href="@{/MainGallery/employerDashboard}" class="fp-filter-clear">Clear</a>
            </div>
        </form>
    </div>

    <!-- Dimmed background behind sidebar -->
    <div id="employerFilterOverlay" class="fp-filter-overlay"></div>

</div>

<!-- üü£ Modal: Project Drill-down -->
<div class="modal fade" id="savedProjectModal" tabindex="-1" aria-labelledby="savedProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="savedProjectModalLabel">Project Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-5 text-center">
                        <img id="savedProjectImage" class="img-fluid rounded shadow-sm"
                             style="max-height: 250px; object-fit: cover;" alt="Project image">
                    </div>
                    <div class="col-md-7">
                        <h5 id="savedProjectName"></h5>
                        <p id="savedProjectDescription" class="small text-muted"></p>
                        <p><strong>Student:</strong> <span id="savedProjectCreator"></span></p>
                        <p><strong>Saved on:</strong> <span id="savedProjectSavedOn"></span></p>
                        <p><strong>Project created on:</strong> <span id="savedProjectProjectCreatedOn"></span></p>

                        <hr>
                        <h6>Your Note</h6>
                        <textarea id="savedProjectNoteInput" class="form-control mb-2" rows="3"
                                  placeholder="Write your note here..."></textarea>
                        <button id="savedProjectNoteSaveBtn" class="btn btn-sm btn-primary">
                            <i class="fas fa-save"></i> Save Note
                        </button>
                        <span id="savedProjectNoteStatus" class="ms-2 small"></span>
                    </div>
                </div>
            </div>

            <div class="modal-footer bg-light">
                <a id="savedProjectViewBtn" href="#" class="btn btn-primary" target="_blank">View Full Project</a>
                <button id="savedProjectRemoveBtn" type="button" class="btn btn-outline-danger">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- PAGINATION (Saved Projects) -->
<div class="d-flex justify-content-center mt-4" th:if="${savedPage.totalElements > 0}">
    <nav aria-label="Saved Projects Pagination">
        <ul class="pagination segmented-pagination">

            <!-- Previous -->
            <li class="page-item"
                th:classappend="${savedPage.first} ? ' disabled'">
                <a class="page-link"
                   th:href="@{/MainGallery/employerDashboard(page=${savedPage.number - 1})}">
                    &lt;
                </a>
            </li>

            <!-- Page Numbers -->
            <li class="page-item"
                th:each="i : ${#numbers.sequence(0, savedPage.totalPages - 1)}"
                th:classappend="${i == savedPage.number} ? ' active'">
                <a class="page-link"
                   th:text="${i + 1}"
                   th:href="@{/MainGallery/employerDashboard(page=${i})}">
                </a>
            </li>

            <!-- Next -->
            <li class="page-item"
                th:classappend="${savedPage.last} ? ' disabled'">
                <a class="page-link"
                   th:href="@{/MainGallery/employerDashboard(page=${savedPage.number + 1})}">
                    &gt;
                </a>
            </li>

        </ul>
    </nav>
</div>

<!-- FOOTER -->
<footer class="fp-footer" id="footer-contact">

    <div class="fp-footer-container">

        <!-- LEFT -->
        <div class="fp-footer-left">
            <img src="/assets/images/website/Future_Proof_Logo.png" class="fp-logo" alt="FutureProof Logo">

            <p class="fp-tagline">
                Empowering students to showcase their<br>
                skills and connect with employers<br>
                ‚Äì from portfolio to profession.
            </p>

            <div class="fp-socials">
                <a href="#"><img src="/assets/images/website/twitter.png" alt="X"></a>
                <a href="#"><img src="/assets/images/website/linkedin.png" alt="LinkedIn"></a>
                <a href="#"><img src="/assets/images/website/facebook.png" alt="Facebook"></a>
                <a href="#"><img src="/assets/images/website/instagram.png" alt="Instagram"></a>
            </div>
        </div>

        <!-- RIGHT GROUP (middle + right) -->
        <div class="fp-footer-right-group">

            <!-- Middle Column -->
            <div class="fp-footer-column">
                <h4>Technological University of<br>The Shannon</h4>
                <p>
                    Athlone Campus<br>
                    University Road, Athlone<br>
                    Co. Westmeath<br>
                    N37 HD68
                </p>
                <p>
                    Phone: <a href="tel:+3539096468000">+353 90 6468000</a><br>
                    Email: <a href="mailto:reception.midlands@tus.ie">reception.midlands@tus.ie</a>
                </p>
            </div>

            <!-- Right Column -->
            <div class="fp-footer-column">
                <h4>Technological University of<br>The Shannon</h4>
                <p>
                    Moylish Campus<br>
                    Moylish Park<br>
                    Limerick<br>
                    V94 EC5T
                </p>
                <p>
                    Phone: <a href="tel:+35361293000">+353 61 293000</a><br>
                    Email: <a href="mailto:reception.midwest@tus.ie">reception.midwest@tus.ie</a>
                </p>
            </div>

        </div>

    </div>

    <img src="/assets/images/website/Future_Proof_Icon_Logo_Low_Opacity.png" class="fp-footer-watermark" alt="">
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function formatDate(value) {
        if (!value) return "N/A";
        const d = new Date(value);
        if (isNaN(d.getTime())) return value;
        return d.toLocaleString();
    }

    // üîπ NEW: remove saved project via POST from modal
    async function removeSavedProject(projectId) {
        if (!confirm("Remove this project from your saved list?")) {
            return;
        }

        const formData = new FormData();
        formData.append("projectId", projectId);

        try {
            const resp = await fetch("/MainGallery/employer/deleteSaved", {
                method: "POST",
                body: formData
            });

            if (resp.ok) {
                // Close modal and refresh page so card disappears
                const modalEl = document.getElementById("savedProjectModal");
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) {
                    modalInstance.hide();
                }
                window.location.reload();
            } else {
                alert("Failed to remove project from saved list.");
            }
        } catch (e) {
            console.error(e);
            alert("Error while removing project.");
        }
    }

    async function openSavedProjectModal(projectId) {
        try {
            const response = await fetch(`/MainGallery/employer/saved/${projectId}/json`);
            const saved = await response.json();

            if (!saved || !saved.project) {
                alert("Project details unavailable.");
                return;
            }

            const p = saved.project;
            document.getElementById("savedProjectName").textContent = p.projectName || "Untitled";
            document.getElementById("savedProjectDescription").textContent = p.projectDescription || "No description available.";
            document.getElementById("savedProjectCreator").textContent = p.user?.userName || "Unknown student";

            document.getElementById("savedProjectSavedOn").textContent = formatDate(saved.createdAt);
            document.getElementById("savedProjectProjectCreatedOn").textContent = formatDate(p.creationDate);

            // Load existing note
            const noteInput = document.getElementById("savedProjectNoteInput");
            noteInput.value = saved.note || "";

            // Handle image
            const img = document.getElementById("savedProjectImage");
            img.src = p.projectHeroImage
                ? `/assets/images/projects/${p.projectHeroImage}`
                : "/assets/images/default-project.jpg";

            // Buttons
            document.getElementById("savedProjectViewBtn").href = `/project/projectDetails/${p.projectId}`;
            document.getElementById("savedProjectRemoveBtn").onclick = () => removeSavedProject(p.projectId);

            // ‚úÖ Save note logic
            const statusLabel = document.getElementById("savedProjectNoteStatus");
            const saveBtn = document.getElementById("savedProjectNoteSaveBtn");
            saveBtn.onclick = async () => {
                const newNote = noteInput.value.trim();
                const formData = new FormData();
                formData.append("projectId", p.projectId);
                formData.append("note", newNote);

                try {
                    const resp = await fetch("/MainGallery/employer/updateNote", {
                        method: "POST",
                        body: formData
                    });
                    if (resp.ok) {
                        statusLabel.textContent = "‚úÖ Saved";
                        statusLabel.style.color = "green";
                    } else {
                        statusLabel.textContent = "‚ö†Ô∏è Failed to save note";
                        statusLabel.style.color = "red";
                    }
                } catch (err) {
                    statusLabel.textContent = "‚ùå Error saving note";
                    statusLabel.style.color = "red";
                    console.error(err);
                }

                // Clear status after a short delay
                setTimeout(() => statusLabel.textContent = "", 3000);
            };

            new bootstrap.Modal(document.getElementById("savedProjectModal")).show();
        } catch (e) {
            console.error(e);
            alert("Error loading project details.");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        // --- Employer filter sidebar toggle ---
        const sidebar = document.getElementById("employerFilterSidebar");
        const overlay = document.getElementById("employerFilterOverlay");
        const toggleBtn = document.getElementById("employerFilterToggle");
        const closeBtn = document.getElementById("employerFilterClose");

        function openSidebar() {
            if (!sidebar) return;
            sidebar.classList.add("open");
            if (overlay) overlay.classList.add("visible");
        }

        function closeSidebar() {
            if (!sidebar) return;
            sidebar.classList.remove("open");
            if (overlay) overlay.classList.remove("visible");
        }

        if (toggleBtn) {
            toggleBtn.addEventListener("click", (e) => {
                e.preventDefault();
                openSidebar();
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener("click", (e) => {
                e.preventDefault();
                closeSidebar();
            });
        }

        if (overlay) {
            overlay.addEventListener("click", closeSidebar);
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        const bulkForm = document.getElementById("employerBulkDeleteForm");
        if (!bulkForm) return; // no saved projects, nothing to wire

        const selectAll = document.getElementById("selectAllSavedProjects");
        const checkboxes = bulkForm.querySelectorAll(".saved-select-checkbox");
        const bulkDeleteBtn = document.getElementById("deleteSelectedSavedBtn");

        function updateBulkUI() {
            let anyChecked = false;
            checkboxes.forEach(cb => {
                if (cb.checked) anyChecked = true;
                const card = cb.closest(".card");
                if (card) {
                    card.classList.toggle("selected-card", cb.checked);
                }
            });
            bulkDeleteBtn.disabled = !anyChecked;
        }

        if (selectAll) {
            selectAll.addEventListener("change", () => {
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
                updateBulkUI();
            });
        }

        checkboxes.forEach(cb => {
            cb.addEventListener("change", () => {
                if (!cb.checked && selectAll) {
                    selectAll.checked = false;
                }
                updateBulkUI();
            });
        });

        // Bulk delete confirmation: only for the "Remove Selected" button
        bulkForm.addEventListener("submit", (e) => {
            if (e.submitter && e.submitter.id === "deleteSelectedSavedBtn") {
                const ok = confirm("Are you sure you want to remove all selected projects from your saved list?");
                if (!ok) {
                    e.preventDefault();
                }
            }
        });
    });
</script>

</body>
</html>
